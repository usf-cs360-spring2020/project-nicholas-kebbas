<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- TODO: Change title -->
    <title>Final Visualization - Nick Kebbas</title>

    <!-- Load Bulma from CDN (consider saving it to repository instead) -->
    <!-- https://bulma.io/ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <link rel="stylesheet" href="./styles.css">

    <!-- Load Font Awesome 5 (free) icons -->
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <!-- D3 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  </head>

  <body>

  <!-- Page header -->
  <!-- https://bulma.io/documentation/layout/hero/ -->
  <section class="hero is-primary is-bold">
    <div class="hero-body">
      <div class="container">
        <!-- TODO: Change title -->
        <h1 class="title">Housing Inventory And Home Values Across States in the United States</h1>
        <!-- TODO: Change subtitle -->
        <h2 class="subtitle">Final Visualization</h2>
      </div>
    </div>
  </section>
  <!-- End page header -->

  <!-- Page navigation -->
  <!-- https://bulma.io/documentation/components/navbar/ -->
  <nav class="navbar is-light" role="navigation" aria-label="main navigation">
    <div class="container">
      <div class="navbar-brand">
        <!-- TODO: Change link to repository homepage if needed -->
        <!-- TODO: Change which navbar-item is-active if needed -->
        <a class="navbar-item is-active" href="index.html">
          <span class="icon"><i class="fas fa-home"></i></span>
          <span>Home</span>
        </a>

        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="main-menu">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="main-menu" class="navbar-menu has-text-weight-medium">
        <!-- Left navbar items -->



        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            Visualizations
          </a>

          <div class="navbar-dropdown">
            <a class="navbar-item" href="./visualization-1.html">
              <span class="icon"><i class="fas fa-map"></i></span>
              <span> Prices Across Counties in the United States</span>
            </a>
            <a class="navbar-item" href="#">
              <span class="icon"><i class="fas fa-map"></i></span>
              <span> Housing Inventory Across States in the United States</span>
            </a>
            <a class="navbar-item" href="./final-visualization.html">
              <span class="icon"><i class="fas fa-map"></i></span>
              <span>Final Visualization</span>
            </a>
          </div>
        </div>
      </div>

        <!-- Right navbar items -->
        <div class="navbar-end">
          <a class="navbar-item" href="./peer-feedback.html" title="Dataset">
            <span class="icon"><i class="fas fa-tasks"></i></span>
            <span>Previous Feedback</span>
          </a>
          <a class="navbar-item" href="./dataset.html" title="Dataset">
            <span class="icon"><i class="fas fa-tasks"></i></span>
            <span>Dataset Information</span>
          </a>

          <a class="navbar-item" href="./about.html" title="About">
            <span class="icon"><i class="fas fa-info-circle"></i></span>
            <span>About</span>
          </a>
        </div>
      </div>

  </nav>
  <!-- Content Area -->
  <section class="section">
    <div class="container">
      <!-- Begin page content -->
      <div class="content">
        <h2> Question </h2>
        <p>What is the relationship between the change in the number of houses sold and the change in the home values of a state? By answering this question, we will also address the project theme of where people are moving, and for what reasons.</p>
        <h2>Findings</h2>
        <p>Overall, because of the number of different (mostly economic) factors that go into finding this relationship, it's difficult to fully answer this question. However, using the visualizations on this page, we can make certain assumptions as to why home values are changing on a state by state basis, where people are buying houses, when people have bought homes in the past, the effects these increases in demand had on the state's supply, and how the state reacted in various cases to changes in demand. Interestingly, we found different relationships from state to state.</p>
        <p>There are multiple cases worth analyzing, since the visualizations let you view both the number of house sales, as well as home values time.  To simplify the analysis, we'll group the states into multiple categories:
          <ul>
          <li>Category 1: States where there was a <b>significant increase in home value</b>, but <b>not a significant increase in number of sales</b>. This suggests that inventory is not increasing, and the state needs to produce more inventory to keep up with demand (if geographically possible). (Examples: California, Nevada, Hawaii, Colorado, Washington D.C.)</li>
          <li>Category 2: States where there was a <b>significant increase in home value</b>, and a <b>significant increase in number of sales</b>. This signals that people are coming to these states at a faster rate than supply is increasing, as the state is successfully expanding available inventory, as well as demand. (Example States: Washington, Oregon, Florida, Texas, Wyoming, Idaho, Vermont)</li>
          <li>Category 3: States where there was <b>not a significant increase in home value</b>, but there was a <b>significant increase in number of sales</b>. This signals that people may be moving to this state, but there's a sufficient supply such that house prices are not increasing. (Example States: South Dakota, Georgia, South Carolina, North Carolina, Tennessee, most other states not listed)</li>
        </ul>
        <p> <b>Please note</b> that the states indicated to be in each category are generalized over the timespan between 2010 and 2019, by the category in which the state was found most often. Each state could technically be found in any category, depending on the specific year being analyzed.</p>
          <p>We'll do some case studies below on certain states to provide additional clarification on why certain states are in certain categories, to help with interpretation of the visualizations.</p>
          <h3> Case Studies: California, Florida, and South Carolina</h3>
          <ul>
            <li>In California (Category 1), in each year from 2008 until 2019, there's a fairly minimal increase (or in some cases a decrease) in housing sales on Zillow.  California house values are also increasing at a high rate year over year.</li>
            <li>In Florida (Category 2), there's a fairly significant increase year over year in number of sales between 2008 and 2019. The Median Home values also increases significantly year over year from 2008 until 2019.</li>
            <li>In South Carolina (Category 3), there's an increase year over year in number of sales between 2008 and 2019. The Median Home values do not increase significantly, indiciating that the state's supply was able to keep up with demand.</li>
          </ul>

      <h2>Potential Issues</h2>
      <p> These datasets are from Zillow, so the data is influenced by the popularity and use of Zillow in those states. </p>

      <!-- End page content -->

  <!-- End page navigation -->
  <h2> Visualization of Housing Sales Changes over Time across the United States </h2>
  <h3> Encoding </h3>

  <p>The circles on the map indicate the percent change in housing sales between selected years (this was incorrectly described as "housing inventory" in the beta version). The size of the circle indicates the size of the percentage change (higher percentage increase equates to a larger circle). The color of the circle, and the state underneath, indicates the direction of change (green circle and darker blue state means an increase in number of sales, while a red circle and lighter blue state means a decrease in number of sales). </p>
  <h3>Interactivity</h3>
<ul>
<li>Tooltips indicate both the state name of the circle, as well as the percentage change in number of sales between those years. </li>
<li>The user can input the starting and ending year of the visualization, so that they can visualize the change in number of house sales over any given period of time between 2008 and 2019.</li>
</ul>
  <div id="tooltip-area"></div>
  <p>Choose Starting Year:
	<select id="option-start">
		<option value="2008-06">2008</option>
		<option value="2009-06">2009</option>
		<option value="2010-06" selected>2010</option>
		<option value="2011-06">2011</option>
		<option value="2012-06">2012</option>
		<option value="2013-06">2013</option>
    <option value="2014-06">2014</option>
    <option value="2015-06">2015</option>
    <option value="2016-06">2016</option>
    <option value="2017-06">2017</option>
    <option value="2018-06">2018</option>
    <option value="2019-06">2019</option>
	</select>
</p>
  <p>Choose Ending Year:
    <select id="option-end">
  		<option value="2008-06">2008</option>
  		<option value="2009-06">2009</option>
  		<option value="2010-06">2010</option>
  		<option value="2011-06">2011</option>
  		<option value="2012-06">2012</option>
  		<option value="2013-06">2013</option>
      <option value="2014-06">2014</option>
      <option value="2015-06">2015</option>
      <option value="2016-06">2016</option>
      <option value="2017-06">2017</option>
      <option value="2018-06">2018</option>
      <option value="2019-06" selected>2019</option>
  	</select>
</p>
</div>
</section>
  <svg width="960" height="600">
    <g id="tooltip" pointer-events="none"></g>
    <g id="details" pointer-events="none"></g>
    <g id="basemap" pointer-events="none"></g>
    <g id="overlay" pointer-events="none"></g>
  </svg>
<section class="section">
  <div class="container">
    <div class="content">
    <h2> Prices Across Counties in the United States</h2>
    <h3>Encoding</h3>
    <p>Home values are encoded by color by county; higher home values are typically a darker shade of blue than lower home values, as indicated by the legend. Please note that we did not control for inflation, so it's expected for the map as a whole to trend darker over time.</p>

      <p>Choose Year:
        <select id="option-start-2">
          <option value="2008-06">2008</option>
          <option value="2009-06">2009</option>
          <option value="2010-06" selected>2010</option>
          <option value="2011-06">2011</option>
          <option value="2012-06">2012</option>
          <option value="2013-06">2013</option>
          <option value="2014-06">2014</option>
          <option value="2015-06">2015</option>
          <option value="2016-06">2016</option>
          <option value="2017-06">2017</option>
          <option value="2018-06">2018</option>
          <option value="2019-06">2019</option>
        </select>
      </p>
    </div>
  </div>
</section>
  <div id="tooltip-area-2"></div>
  <svg id="svg2" width="960" height="600">
    <g id="tooltip-2" pointer-events="none"></g>
    <g id="details-2" pointer-events="none"></g>
    <g id="basemap-2" pointer-events="none"></g>
  </svg>
  <script>
  // attach event listener
  let svg = d3.select("svg");
  let tooltip = svg.select("g#tooltip");
  let details = svg.select("g#details");
  let basemap = svg.select("g#basemap");
  let overlay = svg.select("g#overlay");

  d3.select("#option-start").on("change", change);
  d3.select("#option-end").on("change", change);
  let startingDate;
  let endingDate;
  let startingString;
  let endingString;
  async function startingData() {
    startingString = "2010-06";
    endingString = "2019-06";
  }
  console.log("type ", typeof(startingString))
  // get value of selected index, this takes too much code @javascript
  async function change() {
    function updateDate() {
      console.log("change")
      svg.selectAll("circle").remove()
      svg.selectAll("foreignObject").remove()

      optionStart = document.getElementById("option-start");
      optionEnd = document.getElementById("option-end");
      startingDate = optionStart.options[optionStart.selectedIndex].value;
      endingDate = optionEnd.options[optionEnd.selectedIndex].value;
      console.log(startingDate);
      console.log(endingDate);
    }
    await updateDate()
    loadMap(startingDate, endingDate);
  }

  async function loadMap(startingDate, endingDate) {

      let width = 960;
      let height = 600;

      let path = d3.geoPath();

      let tooltip = svg.select("g#tooltip");
      let details = svg.select("g#details");
      let basemap = svg.select("g#basemap");
      let overlay = svg.select("g#overlay");
      //Define path generator
      // set projection

      // set colors and legend
      let domain = [0,100000, 200000, 300000, 400000, 500000, 600000, 700000, 800000];
      let color = d3.scaleThreshold()
        .domain(domain)
        .range(d3.schemeBlues[9]);

      let x = d3.scaleLinear()
        .domain(domain)
        .rangeRound([800, 900]);

      const tip = tooltip.append("text").attr("id", "tooltip");
      tip.attr("text-anchor", "end");
      tip.attr("dx", -5);
      tip.attr("dy", -5);
      tip.style("visibility", "hidden");
      tooltip.style.transform = "translateY(50px)";

      // source: https://www.d3-graph-gallery.com/graph/custom_legend.html
      svg.append("circle").attr("cx",700).attr("cy",30).attr("r", 10).style("fill", "#65a89d")
      svg.append("circle").attr("cx",700).attr("cy",60).attr("r", 10).style("fill", "#a96a46")
      svg.append("text").attr("x", 720).attr("y", 30).text("Increase in Value").style("font-size", "15px").attr("alignment-baseline","middle")
      svg.append("text").attr("x", 720).attr("y", 60).text("Decrease in Value").style("font-size", "15px").attr("alignment-baseline","middle")

      const details2 = details.append("foreignObject")
        .attr("id", "details")
        .attr("width", 960)
        .attr("height", 500)
        .attr("x", 300)
        .attr("y", -10);

      const body = details2.append("xhtml:body")
        .style("text-align", "left")
        .style("background", "none")
        .html("<p>N/A</p>");

      details.style("visibility", "hidden");

      basemapMap = basemap.append("g")
        .attr("class", "key")
        let mapStateToPrice2010 = new Map()
        let mapStateToPrice2019 = new Map()
        let mapStateToPriceDifference = new Map()
        // first map the county names to the data
        // circle stuff
        var colors = ["#EDF8FB","#41083e"];

        // do for february 2020 first
        await d3.csv("./Sale_Counts_Seas_Adj_State.csv").then(function(data) {
          data.forEach((item, i) => {
              startingString = startingDate;
              endingString = endingDate;
              console.log(startingString)
              console.log(endingString)
              mapStateToPrice2010.set(item.RegionName, item[startingString]);
              mapStateToPrice2019.set(item.RegionName, item[endingString]);
              let price2010 = mapStateToPrice2010.get(item.RegionName);
              let price2019 = mapStateToPrice2019.get(item.RegionName);
              // turn to a percentage
              let priceDifference = (parseInt(price2019) - parseInt(price2010))/parseInt(price2010) * 100;
              mapStateToPriceDifference.set(item.RegionName, priceDifference);
              console.log(priceDifference)
              console.log(mapStateToPriceDifference.get(item.RegionName))
          });
        }).catch(function(error){
           console.log(error)
        })

        d3.json("https://d3js.org/us-10m.v2.json")
        .then(function(us) {
          function appendCircles() {
            let circleSize = d3.scaleLinear().range([0,1]).domain([0, 1]);
            overlay.selectAll("cirle")
            .data(topojson.feature(us, us.objects.states).features)
            .enter().append("circle")
            .attr("cx", function(d) {
              console.log(d.properties)
              var centname = d.properties.name;
              var ctroid;
              ctroid = path.centroid(d)[0];
              return ctroid;
            })
            .attr("cy", function(d) {
              var centname = d.properties.name;
              var ctroid;
              ctroid = path.centroid(d)[1];
              return ctroid;
            })
            .attr("r", function(d) {
              var diff = d.properties.price * 30;
              return circleSize(Math.sqrt(Math.abs(diff)/Math.PI));
            })
            .attr("class", "circ")
            .attr("id", function(d) {return d.abbrev;})
            .attr("fill", function(d) {
              var diff = d.properties.price;
              if(diff>0) {
                return "#65a89d";
              } else {
                return "#a96a46";
              }
            })
            .attr("fill-opacity", "0.5")
            .attr("stroke", "#fff")
            .attr("stroke-weight", "0.5")
          }

          function drawMap() {
            basemapMap.append("g")
                .attr("class", "states")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("cz", -1)
                .attr("fill", function(d) { return color(d.properties.price = mapStateToPriceDifference.get(d.properties.name)); })
                .attr("d", path)
              basemapMap.append("path")
                .attr("class", "state-borders")
                .attr("d", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })))
          }


          function assignTooltip()  {
            console.log("assign tooltip");
            console.log(overlay)
            svg.selectAll('circle').on("mouseover", function(d) {
              console.log("mousing over");
              handleMouseOver(d)
              // this is price for whatever reason
              tip.text(d.properties.name);
              tip.style("visibility", "visible");
            }).on("mouseout", function(d) {
              handleMouseOut(d);
              tip.style("visibility", "hidden");
            });
            let vis = document.getElementsByClassName("states")[0];
          }
          setTimeout(appendCircles, 300)
          setTimeout(assignTooltip, 700)
          setTimeout(drawMap, 200)
    }).catch(function(error) {
      throw(error)
    });

    function handleMouseOver(d) {

      // use template literal for the detail table
      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals
      const html = `
        <table id="tooltip-details" border="0" cellspacing="0" cellpadding="2">
        <tbody>
          <tr>
            <th>Name:</th>
            <td>${d.properties.name}</td>
          </tr>
          <tr>
            <th>Percent Change: </th>
            <td>%${d.properties.price}</td>
          </tr>
        </tbody>
        </table>
      `;

      body.html(html);
      details.style("visibility", "visible");
    }

    function handleMouseOut(d) {
        details.style("visibility", "hidden");
    }
  }

  async function runEverything() {
    await startingData();
    await loadMap(startingString, endingString);
  }
  runEverything();

    </script>
    <!-- Mobile menu responsiveness -->
    <!-- https://bulma.io/documentation/components/navbar/ -->
    <style>

    .states :hover {
      fill: red;
    }
    .states {
      z-index: -100
    }

    #tooltip-details {
      margin: 10px 10px;
    }
    /* IMPORTANT: mouseover doesn't work without pointer events for some reason */
    .circ {
      z-index:1000;
      pointer-events: auto;
    }

    .state-borders {
      fill: none;
      stroke: #fff;
      stroke-width: 0.9px;
      stroke-linejoin: round;
      stroke-linecap: round;
      pointer-events: none;
    }

  </style>

  <!-- Second Visualization -->
  <script>
  let svg2 = d3.select("#svg2");
  d3.select("#option-start-2").on("change", change2);
  let startingDate2;
  let startingString2;
  async function startingData2() {
    startingString2 = "2010-06";
  }

  async function change2() {
    function updateDate() {
      console.log("change")
      svg2.selectAll("circle").remove()
      svg2.selectAll("foreignObject").remove()

      optionStart2 = document.getElementById("option-start-2");
      startingDate2 = optionStart2.options[optionStart2.selectedIndex].value;
      console.log(startingDate2);
    }
    await updateDate()
    loadMapPrice(startingDate2);
  }
  async function loadMapPrice(startingDate) {

      var path2 = d3.geoPath();

      // set colors and legend
      let domain2 = [0,100000, 200000, 300000, 400000, 500000, 600000, 700000, 800000];
      let color2 = d3.scaleThreshold()
        .domain(domain2)
        .range(d3.schemeBlues[9]);

      let x2 = d3.scaleLinear()
      .domain(domain2)
      .rangeRound([800, 840]);

      let tooltip2 = svg2.select("g#tooltip-2");
      let details2 = svg2.select("g#details-2");
      let basemap2 = svg2.select("g#basemap-2")
      // this is bad

      const tip2 = tooltip2.append("text").attr("id", "tooltip");
      tip2.attr("text-anchor", "end");
      tip2.attr("dx", -5);
      tip2.attr("dy", -5);
      tip2.style("visibility", "hidden");
      tooltip2.style.transform = "translateY(50px)";

      const details3 = details2.append("foreignObject")
        .attr("id", "details")
        .attr("width", 960)
        .attr("height", 500)
        .attr("x", 300)
        .attr("y", -10);

      const body2 = details3.append("xhtml:body")
        .style("text-align", "left")
        .style("background", "none")
        .html("<p>N/A</p>");

      details2.style("visibility", "hidden");

      let g = svg2.append("g")
        .attr("class", "key")
        .attr("transform", "translate(-220, 20)");

      g.selectAll("rect")
        .data(color2.range().map(function(d) {
            d = color2.invertExtent(d);
            if (d[0] == null) d[0] = x2.domain()[0];
            if (d[1] == null) d[1] = x2.domain()[1];
            return d;
          }))
        .enter().append("rect")
          .attr("height", 8)
          .attr("x", function(d) { return x2(d[0]); })
          .attr("width", function(d) { return x2(d[1]) - x2(d[0]); })
          .attr("fill", function(d) { return color2(d[0]); });

      g.append("text")
          .attr("class", "caption")
          .attr("x", x2.range()[0])
          .attr("y", -6)
          .attr("fill", "#000")
          .attr("text-anchor", "start")
          .attr("font-weight", "bold")
          .text("Median Home Price");

      g.call(d3.axisBottom(x2)
          .tickSize(13)
          .tickFormat(function(x, i) { return i ? x : x; })
          .tickValues(color2.domain()))
        .select(".domain")
          .remove();

        let mapCountyToPrice = new Map()
        let mapNameToId = new Map()
        // first map the county names to the data
        // do for february 2020 first
        await d3.csv("./County_Zhvi_AllHomes.csv").then(function(data) {
          data.forEach((item, i) => {
              mapCountyToPrice.set(item.RegionName, item[startingDate]);
          });

        })
        .catch(function(error){
           console.log(error)
        })

        d3.json("https://d3js.org/us-10m.v2.json")
        .then(function(us) {

        svg2.append("g")
            .attr("class", "counties")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.counties).features)
            .enter().append("path")
            .attr("fill", function(d) { return color2(d.properties.price = mapCountyToPrice.get(d.properties.name)); })
            .attr("d", path2)
            .append("title")
            .text(function(d) { return d.properties.price });

            // add tooltips
            var toolTip = svg2.selectAll('path').on("mouseover", function(d) {
              handleMouseOver(d)
              // this is price for whatever reason
              tip2.text(d.properties.name);
              tip2.style("visibility", "visible")
            }).on("mouseout", function(d) {
              handleMouseOut(d)
              tip2.style("visibility", "hidden");
            })

      svg2.append("path")
          .attr("class", "county-borders")
          .attr("d", path2(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));

      let vis = document.getElementsByClassName("counties")[0];
      vis.style.margin = "50px 50px";
      }).catch(function(error) {
        throw(error)
      });

      function handleMouseOver(d) {
        console.log(d.properties)

        // use template literal for the detail table
        // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals
        const html = `
          <table id="tooltip-details" border="0" cellspacing="0" cellpadding="2">
          <tbody>
            <tr>
              <th>Name:</th>
              <td>${d.properties.name}</td>
            </tr>
            <tr>
              <th>Price:</th>
              <td>$${d.properties.price}</td>
            </tr>
          </tbody>
          </table>
        `;

        const htmlAlt = `
          <table id="tooltip-details" border="0" cellspacing="0" cellpadding="2">
          <tbody>
            <tr>
              <th>Name:</th>
              <td>${d.properties.name}</td>
            </tr>
            <tr>
              <th>Price:</th>
              <td>No data available</td>
            </tr>
          </tbody>
          </table>
        `;

        if (d.properties.price === undefined) {
          body2.html(htmlAlt);
        } else {
          body2.html(html);
        }
        details2.style("visibility", "visible");
      }

      function handleMouseOut(d) {
          details2.style("visibility", "hidden");
      }
    }

    async function runEverything2() {
      await startingData2();
      await loadMapPrice(startingString);
    }

  runEverything2();

  </script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

    if ($navbarBurgers.length > 0) {
      $navbarBurgers.forEach( el => {
        el.addEventListener('click', () => {
          const target = el.dataset.target;
          const $target = document.getElementById(target);
          el.classList.toggle('is-active');
          $target.classList.toggle('is-active');
        });
      });
    }
  });
  </script>

  </body>

</html>
